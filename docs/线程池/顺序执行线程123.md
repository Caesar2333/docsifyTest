# å…·ä½“çš„æ–¹æ¡ˆ

## âœ… æ¨èè®²è§£é¡ºåºï¼ˆå»ºè®®ä½ è¿™æ ·è·Ÿé¢è¯•å®˜è®²ï¼‰ï¼š

1. **åŸºç¡€æ–¹æ¡ˆ**ï¼š`wait/notify`ï¼ˆå¯é…åˆ synchronizedï¼‰
2. **è¿›é˜¶æ–¹æ¡ˆ**ï¼š`Lock + Condition` æ›¿ä»£ synchronizedï¼Œæ›´çµæ´»
3. **åŒæ­¥å™¨æ–¹æ¡ˆ**ï¼š`CountDownLatch` / `Semaphore` æ§åˆ¶æ‰§è¡Œé¡ºåº
4. **ç‰¹æ®Šæƒ…å†µ**ï¼š`join()`ã€`ExecutorService` å…¶å®ä¸æ˜¯çº¿ç¨‹åä½œæ§åˆ¶ï¼Œæ›´å¤šæ˜¯ä¸»çº¿ç¨‹â€œç­‰ä»–ä»¬æ‰§è¡Œå®Œâ€ï¼Œæœ‰å·®åˆ«

## âœ… ä¸€ã€ä»ä¸šåŠ¡éœ€æ±‚å‡ºå‘

éœ€æ±‚æ˜¯è¿™æ ·çš„ï¼š

- å¼€å¯ä¸‰ä¸ªçº¿ç¨‹ T1ã€T2ã€T3ï¼›

- ä¿è¯æ‰“å°é¡ºåºä¸¥æ ¼æ˜¯ï¼šT1 â†’ T2 â†’ T3ï¼›

- æ¯ä¸ªçº¿ç¨‹å¹²çš„äº‹å°±æ˜¯ï¼š

  ```java
  System.out.println("T1 running");
  ```

## âœ… äºŒã€å°†é—®é¢˜æŠ½è±¡ä¸ºã€çº¿ç¨‹åä½œçš„çŠ¶æ€æ§åˆ¶ã€‘

æˆ‘ä»¬å¸Œæœ›ï¼š
 çº¿ç¨‹ä¸æ˜¯å¹¶å‘ç«äº‰æ‰§è¡Œï¼Œè€Œæ˜¯æ ¹æ®â€œæŸä¸ªå…¨å±€çŠ¶æ€â€æ¥å†³å®šè‡ªå·±æ˜¯å¦å¯ä»¥æ‰§è¡Œã€‚

### ğŸ” çŠ¶æ€å»ºæ¨¡

æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªå˜é‡ï¼š`volatile int state = 1`ï¼Œè¡¨ç¤ºå½“å‰å…è®¸æ‰§è¡Œçš„çº¿ç¨‹ç¼–å·ï¼š

| `state` å€¼ | å½“å‰è¯¥æ‰§è¡Œè° |
| ---------- | ------------ |
| 1          | T1           |
| 2          | T2           |
| 3          | T3           |

æ¯ä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œå‰éƒ½è¦åˆ¤æ–­è¿™ä¸ªçŠ¶æ€æ˜¯å¦æ˜¯è‡ªå·±ï¼Œå¦‚æœæ˜¯ï¼Œå°±æ‰§è¡Œï¼Œç„¶åä¿®æ”¹çŠ¶æ€å”¤é†’å…¶ä»–çº¿ç¨‹ã€‚





# waitå’Œnotifyå¿…é¡»å’ŒSynchronizedä¸€èµ·ä½¿ç”¨

## âœ… ä¸‰ã€synchronized + wait/notifyAll ç‰ˆæœ¬ï¼ˆå…¨æµç¨‹ï¼‰

### ğŸš§ æ­¥éª¤æ‹†è§£

1. åˆ›å»ºä¸€ä¸ªå…±äº«å¯¹è±¡ `final Object lock = new Object();`
2. åˆ›å»ºä¸€ä¸ªå…±äº«çš„ volatile å˜é‡ `volatile int state = 1`
3. æ¯ä¸ªçº¿ç¨‹æ‰§è¡Œé€»è¾‘ï¼š
   - æ‹¿åˆ° `lock`
   - å¦‚æœä¸æ˜¯è‡ªå·±çš„ `state`ï¼Œå°± `wait()`
   - æ˜¯è‡ªå·±çš„ `state` å°±æ‰§è¡Œï¼Œç„¶åä¿®æ”¹ä¸ºä¸‹ä¸€ä¸ªçŠ¶æ€ï¼Œæœ€å `notifyAll()`

### ğŸ”´ ç‰ˆæœ¬ä¸€ï¼š`synchronized` + `wait/notifyAll`

```java
synchronized (lock) {
    while (state != currentState) {
        lock.wait(); // wait æ˜¯ Object çš„æ–¹æ³•ï¼šå½“å‰çº¿ç¨‹æŒ‚åœ¨ lock å¯¹è±¡çš„â€œç­‰å¾…é˜Ÿåˆ—â€é‡Œ
    }
    // æ‰“å°æ¶ˆæ¯
    state = nextState;
    lock.notifyAll(); // å”¤é†’â€œç­‰å¾… lock å¯¹è±¡çš„æ‰€æœ‰çº¿ç¨‹â€
}
```

------

### âœ… æ­£ç¡®å®ç°ä»£ç ï¼ˆé¢è¯•å¯å†™ï¼‰

```java
public class OrderedThreads {

    private static volatile int state = 1; // 1 â†’ T1, 2 â†’ T2, 3 â†’ T3
    private static final Object lock = new Object();

    public static void main(String[] args) {
        Thread t1 = new Thread(() -> runTask(1, 2, "T1 running"));
        Thread t2 = new Thread(() -> runTask(2, 3, "T2 running"));
        Thread t3 = new Thread(() -> runTask(3, 1, "T3 running")); // å›åˆ°1å¯ä»¥å¾ªç¯

        t1.start();
        t2.start();
        t3.start();
    }

    public static void runTask(int currentState, int nextState, String message) {
        synchronized (lock) {
            while (state != currentState) {
                try {
                    lock.wait(); // ä¸è½®åˆ°ä½ ï¼ŒæŒ‚èµ·
                } catch (InterruptedException e) {
                    Thread.currentThread().interrupt();
                }
            }
            System.out.println(message);     // æ‰§è¡Œè‡ªå·±çš„ä»»åŠ¡
            state = nextState;               // æ”¹å˜çŠ¶æ€
            lock.notifyAll();                // å”¤é†’å…¶ä»–çº¿ç¨‹
        }
    }
}
```

------

### ğŸ§  æ¯ä¸€è¡Œè§£é‡Š

- `volatile int state`ï¼šä¿è¯çº¿ç¨‹é—´çŠ¶æ€å¯è§æ€§ï¼Œé˜²æ­¢æœ¬åœ°ç¼“å­˜
- `synchronized(lock)`ï¼šç¡®ä¿åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½è¿›å…¥å…³é”®åŒº
- `while (state != currentState)`ï¼šç»å…¸ç”¨æ³•ï¼Œé˜²æ­¢è™šå‡å”¤é†’ï¼ˆå¿…é¡» while è€Œä¸æ˜¯ ifï¼‰
- `lock.wait()`ï¼šå½“å‰çº¿ç¨‹ä¸æ»¡è¶³æ¡ä»¶ï¼Œä¸»åŠ¨é‡Šæ”¾é”ï¼Œè¿›å…¥ç­‰å¾…é˜Ÿåˆ—
- `state = nextState`ï¼šæ‰§è¡Œå®Œè®¾ç½®ä¸‹ä¸€ä¸ªçº¿ç¨‹çš„ç¼–å·
- `notifyAll()`ï¼šå”¤é†’æ‰€æœ‰çº¿ç¨‹ï¼ˆä¸èƒ½ç”¨ notifyï¼Œé˜²æ­¢é”™å”¤ï¼‰



## notifyå’Œnotifyall()å”¤é†’çº¿ç¨‹çš„åŒºåˆ«

- #### `notify()` æ˜¯**éšæœºå”¤é†’ä¸€ä¸ª**åœ¨è¯¥é”ï¼ˆmonitorï¼‰ä¸Šç­‰å¾…çš„çº¿ç¨‹ï¼›

- #### `notifyAll()` æ˜¯**å”¤é†’æ‰€æœ‰**åœ¨è¯¥é”ä¸Šç­‰å¾…çš„çº¿ç¨‹ã€‚





# ç”¨ `Lock + Condition` å®ç°çº¿ç¨‹é¡ºåºæ§åˆ¶

## âœ… ä¸€ã€æŠ½è±¡å‡ºä¸‰ç»„â€œç­‰å¾…æ¡ä»¶â€

æˆ‘ä»¬ä¾æ—§ä½¿ç”¨ `state = 1/2/3` æ¥ä»£è¡¨è½®åˆ°å“ªä¸ªçº¿ç¨‹æ‰§è¡Œã€‚
 ä½†è¿™æ¬¡æˆ‘ä»¬ä¸å†ç”¨ä¸€ä¸ªé€šç”¨é” + `notifyAll()`ï¼Œè€Œæ˜¯ç²¾ç¡®åœ°è®©ï¼š

- T1 çº¿ç¨‹ç­‰åœ¨ condition1
- T2 çº¿ç¨‹ç­‰åœ¨ condition2
- T3 çº¿ç¨‹ç­‰åœ¨ condition3

## âœ… äºŒã€æ ¸å¿ƒå˜é‡å»ºæ¨¡å¦‚ä¸‹ï¼š

```java
Lock lock = new ReentrantLock();
Condition c1 = lock.newCondition(); // T1 ç­‰åœ¨è¿™
Condition c2 = lock.newCondition(); // T2 ç­‰åœ¨è¿™
Condition c3 = lock.newCondition(); // T3 ç­‰åœ¨è¿™
volatile int state = 1; // è½®åˆ°å“ªä¸ªçº¿ç¨‹ï¼š1->T1, 2->T2, 3->T3
```

* #### æ¯ä¸€ä¸ªconditionï¼Œå¯ä»¥çœ‹åšæ˜¯ç‹¬ç«‹çš„ç­‰å¾…é˜Ÿåˆ—ã€‚

* #### ä½ ä½¿ç”¨`condition.await()`å°±æ˜¯å°†å½“å‰è¿è¡Œçš„çº¿ç¨‹æŒ‚åœ¨å½“å‰çš„ç­‰å¾…çº¿ç¨‹ä¸Šã€‚

```java
lock.lock();
try {
    while (state != currentState) {
        self.await(); // å½“å‰çº¿ç¨‹æŒ‚åœ¨è‡ªå·±çš„ Condition é˜Ÿåˆ—ä¸­
    }
    System.out.println(msg);
    state = nextState;
    next.signal(); // ç²¾ç¡®å”¤é†’â€œä¸‹ä¸€ä¸ª Condition é˜Ÿåˆ—â€çš„çº¿ç¨‹
} finally {
    lock.unlock();
}
```

## âœ… ä¸‰ã€å®Œæ•´ä»£ç å®ç°ï¼ˆæ¯ä¸€è¡Œè§£é‡Šï¼‰

```java
public class OrderedThreadsLockCondition {

    private static final Lock lock = new ReentrantLock();
    private static final Condition c1 = lock.newCondition();
    private static final Condition c2 = lock.newCondition();
    private static final Condition c3 = lock.newCondition();
    private static volatile int state = 1;

    public static void main(String[] args) {
        new Thread(() -> run(1, 2, c1, c2, "T1 running")).start();
        new Thread(() -> run(2, 3, c2, c3, "T2 running")).start();
        new Thread(() -> run(3, 1, c3, c1, "T3 running")).start();
    }

    public static void run(int currentState, int nextState, Condition self, Condition next, String msg) {
            lock.lock();
            try {
                while (state != currentState) {
                    self.await(); // ç­‰å¾…è‡ªå·±çš„ turn
                }
                System.out.println(msg);
                state = nextState;
                next.signal(); // å”¤é†’ä¸‹ä¸€ä¸ªçº¿ç¨‹
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
            } finally {
                lock.unlock();
            }
        
    }
}
```

------

## âœ… æ¯ä¸€è¡Œè®¾è®¡æ€æƒ³è§£è¯»

| ä»£ç è¡Œ                          | æ„ä¹‰                             |
| ------------------------------- | -------------------------------- |
| `lock.lock()`                   | è·å–ç‹¬å é”ï¼Œä¿éšœçº¿ç¨‹å®‰å…¨         |
| `while (state != currentState)` | é¿å…è™šå‡å”¤é†’ï¼ˆå¿…é¡»ä½¿ç”¨ whileï¼‰   |
| `self.await()`                  | å½“å‰çº¿ç¨‹æŒ‚èµ·ï¼Œç­‰å¾… signal å”¤é†’   |
| `System.out.println(msg)`       | æ‰§è¡Œè‡ªå·±çš„é€»è¾‘                   |
| `state = nextState`             | ä¿®æ”¹çŠ¶æ€ï¼Œè½®åˆ°ä¸‹ä¸€ä¸ªçº¿ç¨‹         |
| `next.signal()`                 | å”¤é†’â€œä¸‹ä¸€ä¸ªçº¿ç¨‹â€æ‰€æŒ‚çš„ condition |
| `lock.unlock()`                 | é‡Šæ”¾é”ï¼Œå…¶ä»–çº¿ç¨‹æœ‰æœºä¼šè¿›æ¥       |

## âœ… é¢è¯•æ¨èè®²æ³•

> #### â€œé™¤äº† wait/notifyï¼Œæˆ‘è¿˜å¯ä»¥ç”¨ `ReentrantLock` + `Condition` å®ç°ç²¾å‡†å”¤é†’ã€‚
>
> ####  æˆ‘ä¼šä¸ºæ¯ä¸ªçº¿ç¨‹åˆ†é…ä¸€ä¸ª Conditionï¼Œè®©çº¿ç¨‹åªåœ¨è‡ªå·±çš„ condition ä¸Šç­‰å¾…ï¼Œç„¶åæ‰§è¡Œå®Œå”¤é†’ä¸‹ä¸€ä¸ªçº¿ç¨‹ï¼Œè¿™ç§æ–¹å¼æ›´ç²¾å‡†ï¼Œä¹Ÿé¿å…äº† notifyAll çš„æ— è°“å”¤é†’ã€‚â€



# conditionå’Œnotifyçš„åŒºåˆ«

### ğŸ”´ `wait/notifyAll` æ¨¡å‹ï¼ˆåªèƒ½ä¸€ä¸ªé”…ç‚–ï¼‰

```
Object monitor (lock)
    â”œâ”€â”€ WaitSet:
    â”‚   â”œâ”€â”€ T1ï¼ˆç­‰å¾… state == 1ï¼‰
    â”‚   â”œâ”€â”€ T2ï¼ˆç­‰å¾… state == 2ï¼‰
    â”‚   â””â”€â”€ T3ï¼ˆç­‰å¾… state == 3ï¼‰
    â†“
notifyAll() å”¤é†’å…¨éƒ¨
æ¯ä¸ªçº¿ç¨‹å†çœ‹è‡ªå·± state å¯¹ä¸å¯¹
```

### âœ… `Condition` æ¨¡å‹ï¼ˆæ¡ä»¶åˆ†æµï¼Œåˆ†é”…ç‚–ï¼‰

```
ReentrantLock (lock)
    â”œâ”€â”€ Condition c1 â†’ æŒ‚ T1
    â”œâ”€â”€ Condition c2 â†’ æŒ‚ T2
    â””â”€â”€ Condition c3 â†’ æŒ‚ T3

signal(c2) åªå”¤é†’ T2
signal(c3) åªå”¤é†’ T3
```

æ‰€ä»¥è¿™æ˜¯ç²¾ç¡®è°ƒåº¦ï¼ŒCPU èµ„æºä¸ä¼šç™½è´¹æŠ¢é”ã€‚



# `CountDownLatch` å®ç°çº¿ç¨‹é¡ºåºæ§åˆ¶

## âœ… ä¸‰ã€ä½¿ç”¨ `CountDownLatch` å®ç°çº¿ç¨‹é¡ºåºæ§åˆ¶

------

### ğŸ“Œ é—®é¢˜å›é¡¾ï¼š

æˆ‘ä»¬ä»ç„¶æ˜¯ï¼š

> å¼€å¯ä¸‰ä¸ªçº¿ç¨‹ T1ã€T2ã€T3ï¼Œè¦æ±‚ **æŒ‰é¡ºåºæ‰§è¡Œ**ï¼Œæ¯ä¸ªçº¿ç¨‹åªæ‰§è¡Œä¸€æ¬¡ï¼Œå¹¶æ‰“å°è‡ªå·±çš„åç§°ã€‚

------

## âœ… ä¸€ã€CountDownLatch æ˜¯ä»€ä¹ˆï¼Ÿã€å®šä¹‰ã€ç‰¹ç‚¹ã€æ˜“é”™ç‚¹ã€‘

### ğŸ“– å®šä¹‰

> `CountDownLatch` æ˜¯ JDK å¹¶å‘åŒ…ä¸­çš„ä¸€ä¸ªåŒæ­¥å™¨ï¼Œç”¨æ¥è®©ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ç­‰å¾…å…¶ä»–çº¿ç¨‹å®Œæˆæ“ä½œã€‚

### ğŸ“ ç‰¹ç‚¹

| ç‰¹æ€§                      | è¯´æ˜                                    |
| ------------------------- | --------------------------------------- |
| åˆå§‹æœ‰ä¸€ä¸ªè®¡æ•°å™¨ï¼ˆcountï¼‰ | æ„é€ æ—¶ä¼ å…¥æ•°å­— Nï¼Œè¡¨ç¤ºè¿˜éœ€â€œå€’è®¡æ—¶â€ N æ¬¡ |
| `countDown()`             | æ¯æ¬¡å‡ä¸€                                |
| `await()`                 | çº¿ç¨‹ä¼šé˜»å¡ï¼Œç›´åˆ° count å‡ä¸º 0           |

## âœ… äºŒã€æˆ‘ä»¬å¦‚ä½•åº”ç”¨ CountDownLatch æ¥å®ç°çº¿ç¨‹é¡ºåºï¼Ÿ

### ğŸ’¡ å…³é”®ç‚¹ï¼š

- æˆ‘ä»¬ç”¨ **ä¸¤ä¸ª latch** åˆ†åˆ«æ§åˆ¶ï¼š
  - T2 ç­‰å¾… T1 æ‰§è¡Œå®Œ
  - T3 ç­‰å¾… T2 æ‰§è¡Œå®Œ

## âœ… ä¸‰ã€å®ç°æ­¥éª¤

1. åˆ›å»ºä¸¤ä¸ª latchï¼š

   ```
   CountDownLatch latch1 = new CountDownLatch(1); // æ§åˆ¶ T2
   CountDownLatch latch2 = new CountDownLatch(1); // æ§åˆ¶ T3
   ```

2. çº¿ç¨‹æ‰§è¡Œé€»è¾‘ï¼š

   - T1ï¼šæ‰“å° â†’ `latch1.countDown()`
   - T2ï¼š`await latch1` â†’ æ‰“å° â†’ `latch2.countDown()`
   - T3ï¼š`await latch2` â†’ æ‰“å°

## âœ… å››ã€å®Œæ•´å®ç°ä»£ç ï¼ˆä¸€æ¬¡æ€§é¡ºåºæ‰§è¡Œï¼‰

```java
import java.util.concurrent.CountDownLatch;

public class OrderedThreadsLatch {
    public static void main(String[] args) {

        CountDownLatch latch1 = new CountDownLatch(1); // æ§åˆ¶ T2
        CountDownLatch latch2 = new CountDownLatch(1); // æ§åˆ¶ T3

        Thread t1 = new Thread(() -> {
            System.out.println("T1 running");
            latch1.countDown(); // å”¤é†’ T2
        });

        Thread t2 = new Thread(() -> {
            try {
                latch1.await(); // ç­‰å¾… T1 å®Œæˆ
                System.out.println("T2 running");
                latch2.countDown(); // å”¤é†’ T3
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
        });

        Thread t3 = new Thread(() -> {
            try {
                latch2.await(); // ç­‰å¾… T2 å®Œæˆ
                System.out.println("T3 running");
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
        });

        t3.start(); // æå‰å¯åŠ¨ä¸æ€•ï¼Œåæ­£ä¼šé˜»å¡
        t2.start();
        t1.start();
    }
}
```

## âœ… äº”ã€æ¯ä¸€è¡Œçš„è®¾è®¡è¯´æ˜

| ä»£ç è¡Œ               | æ„ä¹‰                  |
| -------------------- | --------------------- |
| `latch1.await()`     | é˜»å¡ T2ï¼Œç›´åˆ° T1 å®Œæˆ |
| `latch1.countDown()` | T1 æ‰§è¡Œå®Œï¼Œé€šçŸ¥ T2    |
| `latch2.await()`     | é˜»å¡ T3ï¼Œç›´åˆ° T2 å®Œæˆ |
| `latch2.countDown()` | T2 æ‰§è¡Œå®Œï¼Œé€šçŸ¥ T3    |

## âœ… å…­ã€ä¼˜ç¼ºç‚¹æ€»ç»“

| ä¼˜ç‚¹                   | è¯´æ˜                   |
| ---------------------- | ---------------------- |
| ç®€å•å¥½ç”¨               | ä¸ç”¨è‡ªå·±ç»´æŠ¤çŠ¶æ€å˜é‡   |
| éå¸¸é€‚åˆä¸€æ¬¡æ€§é¡ºåºæ§åˆ¶ | ä¸ç”¨å¾ªç¯ï¼Œä¸ç”¨å”¤é†’é”™äºº |

| ç¼ºç‚¹                 | è¯´æ˜                                        |
| -------------------- | ------------------------------------------- |
| åªèƒ½ç”¨ä¸€æ¬¡           | `CountDownLatch` ä¸èƒ½é‡ç½®ï¼Œåªèƒ½â€œå€’è®¡æ—¶ä¸€æ¬¡â€ |
| æ— æ³•å®ç°æ— é™è½®æµæ§åˆ¶ | ä¸é€‚åˆå¾ªç¯é¡ºåºæ‰§è¡Œçš„éœ€æ±‚ï¼ˆå¦‚ ABCABCABCï¼‰    |



# ä½¿ç”¨ `Semaphore` å®ç°é¡ºåºæ§åˆ¶

### ğŸ“Œ Semaphore æ˜¯ä»€ä¹ˆï¼Ÿ

> `Semaphore` æ˜¯ JDK å¹¶å‘åŒ…ä¸­çš„ä¸€ä¸ª**è®¡æ•°ä¿¡å·é‡**ï¼Œå¯ä»¥æ§åˆ¶å¤šä¸ªçº¿ç¨‹å¯¹æŸä¸ªèµ„æºçš„å¹¶å‘è®¿é—®æ•°é‡ã€‚

### ğŸ§  ç‰¹ç‚¹å›é¡¾

| æ–¹æ³•               | ä½œç”¨                          |
| ------------------ | ----------------------------- |
| `new Semaphore(n)` | åˆ›å»º n ä¸ªè®¸å¯ï¼ˆé»˜è®¤ä¸å¯é‡å…¥ï¼‰ |
| `acquire()`        | è·å–è®¸å¯ï¼Œè‹¥æ— å¯ç”¨åˆ™é˜»å¡      |
| `release()`        | é‡Šæ”¾è®¸å¯ï¼Œå”¤é†’ç­‰å¾…çº¿ç¨‹        |

## âœ… æ€è€ƒå»ºæ¨¡ï¼šä¸‰ä¸ªä¿¡å·ç¯æ§åˆ¶ä¸‰ä¸ªçº¿ç¨‹è°èƒ½æ‰§è¡Œ

æˆ‘ä»¬å¯ä»¥ï¼š

- å®šä¹‰ 3 ä¸ªä¿¡å·é‡ï¼š

  ```java
  Semaphore s1 = new Semaphore(1); // åˆå§‹å…è®¸ T1 æ‰§è¡Œ
  Semaphore s2 = new Semaphore(0); // T2 åˆå§‹é˜»å¡
  Semaphore s3 = new Semaphore(0); // T3 åˆå§‹é˜»å¡
  ```

- ç„¶åï¼š

| çº¿ç¨‹ | ç­‰å¾…å“ªä¸ªä¿¡å·ç¯ | æ‰§è¡Œå®Œåæ”¾è¡Œè° |
| ---- | -------------- | -------------- |
| T1   | s1.acquire()   | s2.release()   |
| T2   | s2.acquire()   | s3.release()   |
| T3   | s3.acquire()   | -              |

## âœ… å®Œæ•´å®ç°ä»£ç ï¼ˆåªæ‰§è¡Œä¸€è½®ï¼‰

```java
import java.util.concurrent.Semaphore;

public class OrderedThreadsSemaphore {
    public static void main(String[] args) {

        Semaphore s1 = new Semaphore(1); // T1 åˆå§‹å¯ä»¥æ‰§è¡Œ
        Semaphore s2 = new Semaphore(0); // T2 åˆå§‹é˜»å¡
        Semaphore s3 = new Semaphore(0); // T3 åˆå§‹é˜»å¡

        Thread t1 = new Thread(() -> {
            try {
                s1.acquire(); // è·å–æ‰§è¡Œæƒ
                System.out.println("T1 running");
                s2.release(); // æ”¾è¡Œ T2
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
        });

        Thread t2 = new Thread(() -> {
            try {
                s2.acquire(); // ç­‰å¾… T1 æ”¾è¡Œ
                System.out.println("T2 running");
                s3.release(); // æ”¾è¡Œ T3
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
        });

        Thread t3 = new Thread(() -> {
            try {
                s3.acquire(); // ç­‰å¾… T2 æ”¾è¡Œ
                System.out.println("T3 running");
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
        });

        // ä»»æ„é¡ºåºå¯åŠ¨éƒ½ä¸ä¼šå½±å“
        t3.start();
        t2.start();
        t1.start();
    }
}
```

## âœ… æ¯ä¸€è¡Œè§£é‡Šï¼š

| ä»£ç è¡Œ                            | æ„ä¹‰                      |
| --------------------------------- | ------------------------- |
| `Semaphore s1 = new Semaphore(1)` | T1 åˆå§‹å°±èƒ½æ‰§è¡Œ           |
| `s1.acquire()`                    | T1 ç­‰å¾…è®¸å¯ï¼ˆç«‹åˆ»æˆåŠŸï¼‰   |
| `s2.acquire()`                    | T2 é˜»å¡ç›´åˆ° T1 æ‰§è¡Œå®Œé‡Šæ”¾ |
| `s2.release()`                    | T1 æ‰§è¡Œå®Œï¼Œå”¤é†’ T2        |
| `s3.acquire()`                    | T3 é˜»å¡ç›´åˆ° T2 æ‰§è¡Œå®Œ     |
| `s3.release()`                    | T2 æ‰§è¡Œå®Œï¼Œå”¤é†’ T3        |

## âœ… å¦‚æœè¦æ‰§è¡Œå¤šè½®æ€ä¹ˆåŠï¼Ÿ

åªéœ€å°†æ¯ä¸ªçº¿ç¨‹é€»è¾‘åŒ…è£…è¿›å¾ªç¯å³å¯ï¼š

```
for (int i = 0; i < 5; i++) {
    s1.acquire();
    System.out.println("T1 running");
    s2.release();
}
```

å…¶ä½™çº¿ç¨‹åŒç†ã€‚è¿™æ ·å°±æ˜¯ `T1 â†’ T2 â†’ T3 â†’ T1 â†’ T2 â†’ T3` å¤šè½®æ‰§è¡Œã€‚





# joinçš„æœ¬è´¨ä»€ä¹ˆï¼Ÿï¼Ÿè°æ¥è°ƒç”¨joinçš„æ–¹æ³•ï¼Ÿè°ƒç”¨joinçš„çº¿ç¨‹åœ¨ç­‰è°ï¼Ÿ

## âœ… ä¸€ã€ç»“è®ºå…ˆè¡Œï¼šä¸€å¥è¯å›ç­”ä½ 

> #### **join() æ˜¯ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨å¦ä¸€ä¸ªçº¿ç¨‹çš„ join() æ–¹æ³•ï¼Œè¡¨ç¤ºâ€œæˆ‘ç­‰ä½ æ‰§è¡Œå®Œæˆ‘å†ç»§ç»­â€ã€‚**

### ğŸ”¥ æœ¬è´¨è¡Œä¸ºï¼š

> `A.join()` çš„å«ä¹‰æ˜¯ï¼š**å½“å‰çº¿ç¨‹ï¼ˆè°ƒç”¨è€…ï¼‰æš‚åœæ‰§è¡Œï¼Œç­‰çº¿ç¨‹ A æ‰§è¡Œå®Œæ¯•å†ç»§ç»­ã€‚**

## âœ… äºŒã€è°æ¥è°ƒç”¨ `join()`ï¼Ÿ

### âœ… æ˜¯**ä¸»çº¿ç¨‹æˆ–å…¶ä»–çº¿ç¨‹**æ¥è°ƒç”¨ï¼š

```java
Thread t = new Thread(() -> {
    System.out.println("å­çº¿ç¨‹æ‰§è¡Œä¸­");
});
t.start();  // å¯åŠ¨çº¿ç¨‹
t.join();   // ä¸»çº¿ç¨‹ï¼šæˆ‘è°ƒç”¨ä½ çš„ joinï¼Œæˆ‘ç­‰ä½ å¹²å®Œæˆ‘å†å¹²
System.out.println("ä¸»çº¿ç¨‹ç»§ç»­æ‰§è¡Œ");
```

### â—æ³¨æ„ï¼š

> ä¸æ˜¯ `t` è‡ªå·±è°ƒç”¨è‡ªå·±çš„ joinï¼Œè€Œæ˜¯â€œåˆ«äººâ€æ¥è°ƒç”¨å®ƒçš„ `join()`ï¼

## âœ… ä¸‰ã€è°åœ¨ç­‰å¾…ï¼Ÿ

è¿˜æ˜¯åˆšæ‰é‚£å¥è¯ï¼š

```java
t.join();
```

ä½ è¦è¿™ä¹ˆè¯»å®ƒï¼š

> â€œå½“å‰çº¿ç¨‹è¦ç­‰ `t` æ‰§è¡Œå®Œï¼Œå†ç»§ç»­ã€‚â€

### ä¹Ÿå°±æ˜¯ï¼š

- æ˜¯â€œæˆ‘è°ƒç”¨äº†ä½ çš„ joinâ€
- æ‰€ä»¥æ˜¯â€œ**æˆ‘åœ¨ç­‰ä½ **â€
- `join()` æ–¹æ³•è®©**æˆ‘é˜»å¡åœ¨è¿™é‡Œï¼Œç›´åˆ°ä½ æ­»ï¼ˆå³æ‰§è¡Œå®Œï¼‰â€

------

## âœ… å››ã€èƒŒååº•å±‚åˆ°åº•åšäº†ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆèƒ½â€œç­‰åˆ«äººæ‰§è¡Œå®Œâ€ï¼Ÿ

æˆ‘ä»¬çœ‹æºç ğŸ‘‡ï¼ˆJava Thread æºç ï¼‰

```java
public final void join() throws InterruptedException {
    synchronized (lock) {
        while (isAlive()) {
            lock.wait(); // è°ƒç”¨è€…æŒ‚èµ·
        }
    }
}
```

### ğŸ“Œ æœ¬è´¨ä¸Šï¼š

1. ä½ è°ƒç”¨ `t.join()`ï¼Œè¿›å…¥ `t` å†…éƒ¨çš„ä¸€ä¸ª `lock`ï¼›
2. å¦‚æœ `t.isAlive()`ï¼Œè¯´æ˜çº¿ç¨‹è¿˜åœ¨è·‘ï¼Œè°ƒç”¨è€…å°±æ‰§è¡Œ `wait()`ï¼›
3. å½“ `t` çº¿ç¨‹è·‘å®Œåï¼Œå®ƒä¼šæ‰§è¡Œ `lock.notifyAll()`ï¼ˆåœ¨çº¿ç¨‹é€€å‡ºæ—¶è§¦å‘ï¼‰ï¼›
4. è°ƒç”¨è€…çº¿ç¨‹è¢«å”¤é†’ï¼Œç»§ç»­å¾€ä¸‹æ‰§è¡Œã€‚

## âœ… äº”ã€å›¾è§£ï¼šçº¿ç¨‹è°ƒç”¨ join çš„æ‰§è¡Œå…³ç³»

```java
mainçº¿ç¨‹ï¼š
    Thread t = new Thread(...);
    t.start();
    t.join(); â† main åœ¨è¿™æŒ‚èµ·ï¼Œç­‰ t æ‰§è¡Œå®Œ

tçº¿ç¨‹ï¼š
    run() â†’ æ‰§è¡Œä¸­...
    // æ‰§è¡Œå®Œï¼Œç³»ç»Ÿä¼šé€šçŸ¥æ‰€æœ‰ join() çš„çº¿ç¨‹ç»§ç»­
```

## âœ… å…­ã€ç»å…¸ä¾‹å­è®²é€

```java
Thread t1 = new Thread(() -> {
    System.out.println("T1 å¼€å§‹å¹²æ´»");
    sleep(1000);
    System.out.println("T1 å¹²å®Œäº†");
});

System.out.println("ä¸»çº¿ç¨‹å¯åŠ¨ T1");
t1.start();
t1.join(); // ä¸»çº¿ç¨‹æŒ‚èµ·ï¼Œç­‰ T1 å¹²å®Œ
System.out.println("ä¸»çº¿ç¨‹ç»§ç»­æ‰§è¡Œ");
```

















