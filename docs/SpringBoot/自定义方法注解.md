# è‡ªå®šä¹‰æ–¹æ³•æ³¨è§£çš„æµç¨‹

åƒè¿™æ ·ç”¨ï¼š

```java
@GetMapping("/profile")
public R<UserDTO> getProfile(@LoginUser SysUser user) {
    return R.ok(user);
}
```

éå¸¸ä¼˜é›…ã€‚ä½†ä½ å¿…é¡»è‡ªå·±å†™ä¸€æ•´å¥—å®ç°ï¼ŒåŒ…æ‹¬ï¼š

------

## âœ… ä¸€ã€ä½ è¦åšå“ªäº›äº‹ï¼Ÿ

| æ­¥éª¤ | è¯´æ˜                                 | å…·ä½“ä½œç”¨                      |
| ---- | ------------------------------------ | ----------------------------- |
| 1ï¸âƒ£    | å®šä¹‰ `@LoginUser` æ³¨è§£               | æ ‡è¯† Controller å‚æ•°          |
| 2ï¸âƒ£    | å®ç° `HandlerMethodArgumentResolver` | æ³¨å…¥å‚æ•°æ—¶è‡ªåŠ¨å» Redis é‡Œè§£æ |
| 3ï¸âƒ£    | åœ¨ `WebMvcConfigurer` ä¸­æ³¨å†Œè§£æå™¨   | è®© Spring çŸ¥é“è¿™ä¸ªåŠŸèƒ½        |



æˆ‘ç°åœ¨å°±ä¸€æ­¥ä¸€æ­¥æ•™ä½ æ€ä¹ˆåšï¼Œæ•´å¥—èƒ½ç›´æ¥å¤åˆ¶è¿›é¡¹ç›®è·‘èµ·æ¥ âœ…

------

## âœ… äºŒã€Step 1ï¼šå®šä¹‰æ³¨è§£ @LoginUser

```java
@Target(ElementType.PARAMETER)
@Retention(RetentionPolicy.RUNTIME)
@Documented
public @interface LoginUser {
}
```

è¿™è¡¨ç¤ºè¿™ä¸ªæ³¨è§£æ˜¯æ ‡åœ¨â€œæ–¹æ³•å‚æ•°â€ä¸Šçš„ï¼Œè€Œä¸”ä¿ç•™åˆ°è¿è¡Œæ—¶ã€‚

------

## âœ… ä¸‰ã€Step 2ï¼šå®ç°å‚æ•°è§£æå™¨ LoginUserResolver

```java
@Component
public class LoginUserResolver implements HandlerMethodArgumentResolver {

    @Autowired
    private StringRedisTemplate stringRedisTemplate;

    @Override
    public boolean supportsParameter(MethodParameter parameter) {
        // åˆ¤æ–­å‚æ•°ä¸Šæ˜¯å¦æœ‰ @LoginUser æ³¨è§£
        return parameter.hasParameterAnnotation(LoginUser.class)
               && parameter.getParameterType().equals(SysUser.class);
    }

    @Override
    public Object resolveArgument(MethodParameter parameter, 
                                  ModelAndViewContainer mavContainer, 
                                  NativeWebRequest webRequest, 
                                  WebDataBinderFactory binderFactory) throws Exception {

        HttpServletRequest request = webRequest.getNativeRequest(HttpServletRequest.class);
        String token = request.getHeader("Authorization");

        if (StrUtil.isBlank(token)) {
            return null; // æˆ–æŠ›å‡ºæœªç™»å½•å¼‚å¸¸
        }

        String key = "login:token:" + token;
        Map<Object, Object> userMap = stringRedisTemplate.opsForHash().entries(key);

        if (userMap.isEmpty()) {
            return null; // æˆ–æŠ›å‡ºæœªç™»å½•å¼‚å¸¸
        }

        // æŠŠ Redis ä¸­çš„æ•°æ®è½¬æˆ SysUserï¼ˆä½ å¯æ ¹æ®éœ€è¦è½¬æ¢ä¸º DTOï¼‰
        SysUser user = BeanUtil.fillBeanWithMap(userMap, new SysUser(), false);
        return user;
    }
}
```

> ğŸ’¡ æ³¨æ„ï¼šä½ å¯ä»¥è‡ªå·±æ›¿æ¢ä¸º `UserDTO` æˆ–å…¶ä»–ç®€åŒ–ç‰ˆæœ¬ï¼Œåªè¦ç±»å‹åŒ¹é…å³å¯ã€‚

------

## âœ… å››ã€Step 3ï¼šæ³¨å†Œè§£æå™¨åˆ° Spring MVC ä¸­

```java
@Configuration
public class WebConfig implements WebMvcConfigurer {

    @Autowired
    private LoginUserResolver loginUserResolver;

    @Override
    public void addArgumentResolvers(List<HandlerMethodArgumentResolver> resolvers) {
        resolvers.add(loginUserResolver);
    }
}
```

------

## âœ… äº”ã€ä½ ç°åœ¨å°±å¯ä»¥è¿™æ ·ç”¨äº†ï¼

```java
@GetMapping("/logout")
public R<Void> logout(@LoginUser SysUser user) {
    String tokenKey = "login:token:" + user.getToken(); // æˆ– request header è·å–
    stringRedisTemplate.delete(tokenKey);
    return R.ok();
}
```

å½“ç„¶ï¼Œè¿™ä¸ª `user.getToken()` ä½ å¯ä»¥è‡ªå·±å°è£…è¿› user é‡Œï¼Œæˆ–è€…é¢å¤–ä¼ å…¥ã€‚

------

## âœ… å…­ã€å»ºè®®çš„ç”¨æˆ·æ•°æ®ç»“æ„ï¼šUserDTO

ä¸ºäº†é¿å…æŠŠå¯†ç ç­‰å­—æ®µæš´éœ²å‡ºå»ï¼Œå»ºè®®ä½ ï¼š

- ç™»å½•æˆåŠŸåï¼ŒåªæŠŠ user è½¬ä¸ºä¸€ä¸ªè½»é‡åŒ–çš„ `UserDTO` å­˜è¿› Redisï¼›
- æ³¨å…¥çš„æ—¶å€™ä¹Ÿåªæ³¨å…¥ `UserDTO`ã€‚

```java
@Data
public class UserDTO {
    private Long id;
    private String username;
    private String nickname;
}
```

è¿™æ ·ä¹Ÿå®‰å…¨ã€æ€§èƒ½æ›´é«˜ã€‚

## ä¼˜åŒ–æ–¹å¼

## âœ… äº”ã€ä¼˜åŒ–æ–¹å¼ï¼šå‚æ•°è§£æå™¨å…ˆä» `UserHolder.get()` æ‹¿

ä½ å¯ä»¥åœ¨ `LoginUserResolver` ä¸­è¿™æ ·å†™ï¼š

```java
@Override
public Object resolveArgument(...) {
    // å…ˆä» ThreadLocal æ‹¿
    UserDTO user = UserHolder.get();
    if (user != null) {
        return user;
    }

    // ä¸è¡Œå†å» Redis æ‹¿ï¼ˆå…œåº•ç­–ç•¥ï¼‰
    String token = request.getHeader("Authorization");
    if (StrUtil.isBlank(token)) return null;
    Map<Object, Object> userMap = redis.opsForHash().entries("login:token:" + token);
    if (userMap.isEmpty()) return null;

    user = BeanUtil.fillBeanWithMap(userMap, new UserDTO(), false);
    return user;
}
```

âœ… è¿™æ ·å°±ç»Ÿä¸€äº†ç¼“å­˜æœºåˆ¶ï¼Œæ—¢ä¸å†—ä½™ï¼Œåˆæ”¯æŒçµæ´»æ‰©å±•ã€‚

## âœ… æ€»ç»“ä¸€å¥è¯ï¼š

> `@LoginUser` æ˜¯å¯¹ `UserHolder.get()` çš„ä¸€ç§è¯­æ³•ç³–å’Œæ³¨è§£åŒ–å°è£…ï¼Œæœ€ç»ˆä½ è¿˜æ˜¯è¦åœ¨æ‹¦æˆªå™¨é‡Œ **ä» Redis æ‹¿åˆ°ç”¨æˆ· â†’ å­˜å…¥ ThreadLocal**ï¼Œè€Œè§£æå™¨åªæ˜¯è´Ÿè´£**åœ¨ Controller å‚æ•°ä¸­ä¼˜é›…æ³¨å…¥**ã€‚



# è‡ªå®šä¹‰æ³¨è§£æ€ä¹ˆå†™ï¼Ÿ

## âœ… ä¸€ã€è‡ªå®šä¹‰æ³¨è§£æœ€å¸¸ç”¨çš„ç”¨é€”æ˜¯ä»€ä¹ˆï¼Ÿ

ä½ ç›®å‰ç”¨çš„æ˜¯ï¼š

```java
@Target(ElementType.PARAMETER)
@Retention(RetentionPolicy.RUNTIME)
@Documented
public @interface LoginUser {
}
```

è¿™æ˜¯ä¸ºäº†è§£å†³ï¼š

> **åœ¨ Controller ä¸­æ³¨å…¥å‚æ•°çš„æ³¨è§£å‹æ ‡è¯†**

ç±»ä¼¼äº Spring MVC ä¸­çš„ `@RequestParam`ã€`@PathVariable`ï¼Œéƒ½æ˜¯åœ¨å‚æ•°ä¸Šæ‰“çš„æ³¨è§£ã€‚

------

## âœ… äºŒã€è‡ªå®šä¹‰æ³¨è§£çš„è¯­æ³•ç»“æ„æ¨¡æ¿

```java
@Target(...)              // æ³¨è§£èƒ½å†™åœ¨å“ªå„¿ï¼ˆç±»/æ–¹æ³•/å‚æ•°/å­—æ®µï¼‰
@Retention(...)           // æ³¨è§£ä¿ç•™åˆ°å“ªä¸ªé˜¶æ®µï¼ˆæºç /ç¼–è¯‘/è¿è¡Œæ—¶ï¼‰
@Documented               // æ˜¯å¦ç”Ÿæˆåœ¨ Javadoc ä¸­ï¼ˆéå¿…é¡»ï¼‰
@Inherited                // å­ç±»æ˜¯å¦å¯ä»¥ç»§æ‰¿çˆ¶ç±»ä¸Šçš„æ³¨è§£ï¼ˆå¤šç”¨äºç±»ä¸Šï¼‰

public @interface Xxx {
    // ä½ å¯ä»¥å®šä¹‰ä¸€äº›é…ç½®é¡¹ï¼š
    String value() default "";
    boolean required() default true;
}
```

* **`@Inherited` åªå¯¹ç±»ä¸Šçš„æ³¨è§£æœ‰æ•ˆï¼Œç”¨äºæŒ‡å®šå­ç±»æ˜¯å¦å¯ä»¥â€œç»§æ‰¿â€çˆ¶ç±»çš„ç±»çº§æ³¨è§£ã€‚**

  âš ï¸ å®ƒ**åªç”Ÿæ•ˆäº `@Target(ElementType.TYPE)`** çš„æ³¨è§£ï¼Œ**å¯¹å­—æ®µã€æ–¹æ³•ã€å‚æ•°æ³¨è§£ä¸€å¾‹æ— æ•ˆ**ï¼

## âœ… ä¸‰ã€ä½ å†™çš„æ³¨è§£ `@LoginUser` è§£é‡Šå¦‚ä¸‹ï¼š

| æ³¨è§£                  | ä½œç”¨                                                     |
| --------------------- | -------------------------------------------------------- |
| `@Target(PARAMETER)`  | è¯´æ˜è¿™ä¸ªæ³¨è§£åªèƒ½å†™åœ¨æ–¹æ³•å‚æ•°ä¸Šï¼ˆä¸èƒ½å†™åœ¨ç±»/å­—æ®µ/æ–¹æ³•ä¸Šï¼‰ |
| `@Retention(RUNTIME)` | è¯´æ˜æ³¨è§£ä¿ç•™åˆ°è¿è¡Œæ—¶ï¼ˆSpring æ‰èƒ½é€šè¿‡åå°„è¯»å–åˆ°å®ƒï¼‰      |
| `@Documented`         | å¦‚æœå†™äº† Javadocï¼Œè¿™ä¸ªæ³¨è§£ä¼šä¸€èµ·ç”Ÿæˆè¿›å»ï¼ˆå¼€å‘è¾…åŠ©ï¼‰     |



# åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ

### ğŸš€ é¢è¯•å›ç­”æ¨¡æ¿ï¼š

> #### â€œå½“æˆ‘åœ¨ Controller æ–¹æ³•å‚æ•°ä¸Šå†™äº†ä¸€ä¸ªè‡ªå®šä¹‰æ³¨è§£ï¼ˆå¦‚ `@LoginUser`ï¼‰æ—¶ï¼ŒSpring ä¼šåœ¨æ‰§è¡Œè¯·æ±‚åˆ°è¾¾è¯¥æ–¹æ³•ä¹‹å‰ï¼Œä¾æ¬¡è°ƒç”¨æ³¨å†Œçš„ HandlerMethodArgumentResolver è§£æå™¨åˆ—è¡¨ï¼Œå¯¹æ¯ä¸ªå‚æ•°è¿›è¡Œè§£æã€‚åªè¦æŸä¸ªè§£æå™¨çš„ `supportsParameter()` è¿”å› trueï¼ŒSpring å°±ä¼šè°ƒç”¨è¯¥è§£æå™¨çš„ `resolveArgument()` æ–¹æ³•ï¼Œé€šè¿‡åå°„ã€è¯·æ±‚å¤´ã€Redis æˆ– ThreadLocal ç­‰æ‰‹æ®µç”Ÿæˆç›®æ ‡å‚æ•°å®ä¾‹æ³¨å…¥ã€‚æ•´ä¸ªæµç¨‹ç”± DispatcherServlet æ§åˆ¶ï¼Œæ ¸å¿ƒåŸºäºç­–ç•¥æ¨¡å¼ + SPI æ’ä»¶æœºåˆ¶å®ç°ï¼Œæœ€å¤§ç‰¹ç‚¹æ˜¯è§£è€¦ã€é«˜æ‰©å±•ã€‚â€



## âœ… äºŒã€ğŸŒ³ Spring MVC çš„çœŸå®æœºåˆ¶æ˜¯è¿™æ ·çš„ï¼š

Spring æ˜¯è¿™æ ·æ‰§è¡Œçš„ï¼š

```java
for (MethodParameter parameter : method.getParameters()) {
    for (HandlerMethodArgumentResolver resolver : allResolvers) {
        if (resolver.supportsParameter(parameter)) {
            Object arg = resolver.resolveArgument(parameter, ...);
            // æ³¨å…¥æˆåŠŸï¼
        }
    }
}
```

ä¹Ÿå°±æ˜¯è¯´ï¼š

- Spring æ˜¯**æ¯ä¸€ä¸ªå‚æ•°**éå†æ‰€æœ‰è§£æå™¨ï¼Œè¯¢é—®ä¸€éï¼š

  > â€œä½ èƒ½è§£æè¿™ä¸ªå‚æ•°å—ï¼Ÿâ€

- å¦‚æœæŸä¸ªè§£æå™¨çš„ `supportsParameter(parameter)` è¿”å› `true`ï¼Œå°±è°ƒç”¨å®ƒçš„ `resolveArgument()` å»è§£æ

- æ‰€ä»¥ï¼š**ä½ åœ¨ supportsParameter() ä¸­è¦è‡ªå·±åˆ¤æ–­æ¸…æ¥š**









